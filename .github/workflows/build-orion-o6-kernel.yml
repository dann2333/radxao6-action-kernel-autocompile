name: Build Orion O6 Kernel Debs

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    env:
      REVISION: 1
    steps:
      - name: Checkout BSP sources
        uses: actions/checkout@v5
        with:
          repository: radxa-repo/bsp
          submodules: true
      - name: Install dependency
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y qemu-user-static binfmt-support
      - name: Add Orion O6 profile
        run: |
          profile_source="linux/.rk3588"
          if [ ! -d "$profile_source" ]; then
            if [ -d linux/rk3588 ]; then
              profile_source="linux/rk3588"
            else
              echo "Error: rk3588 profile not found at linux/.rk3588 or linux/rk3588. Ensure the BSP repository checkout includes the required profile." >&2
              exit 1
            fi
          fi
          cp -a "$profile_source" linux/orion-o6
          sed -i 's/SUPPORTED_BOARDS=("rk3588")/SUPPORTED_BOARDS=("orion-o6")/' linux/orion-o6/fork.conf
      - name: Build kernel debs
        run: |
          mkdir .output
          pushd .output
          ../bsp --long-version -r "$REVISION" linux orion-o6
          popd
      - name: Upload bsp artifacts
        uses: actions/upload-artifact@v5
        with:
          name: linux_orion-o6_${{ env.REVISION }}
          path: .output
      - name: Upload release artifacts
        if: github.event.release.id
        uses: xresloader/upload-to-github-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ github.event.release.id }}
          file: .output/*
      - name: Rollback release
        if: failure() && github.event.release.id
        uses: author/action-rollback@stable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ github.event.release.id }}
      - name: Stage output
        if: always()
        run: |
          mkdir -p out/linux
          if [ -d .output ]; then
            cp -a .output/. out/linux/
          fi
      - name: Upload build output
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: linux_orion-o6_output
          path: out/linux
